<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Suscripciones</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <style>
    .chart-container {
      width: 100%;
      height: 800px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- Barra de navegación -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Suscripciones</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-tab="rose">Gráfico Nightingale</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-tab="line">Gráfico de Líneas</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-tab="bar">Gráfico de Barras</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenedores de gráficos -->
  <div id="rose-chart" class="chart-container"></div>
  <div id="line-chart" class="chart-container" style="display:none;"></div>
  <div id="bar-chart" class="chart-container" style="display:none;"></div>

  <script>
    const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
    let datosAcumulados = null;
    let datosBar = null;

    let chartLine = null;
    let chartRose = null;
    let chartBar = null;

    // --- Fetch datos acumulados para Line y Rose ---
    fetch("acumulados.json")
      .then(res => res.json())
      .then(datos => { datosAcumulados = datos; initRoseChart(); });

    // --- Fetch datos para Bar ---
    fetch("data.json")
      .then(res => res.json())
      .then(datos => { datosBar = datos; });

    // --- Funciones para crear gráficos (cada vez que se abre la tab) ---
    function initLineChart() {
      if (!chartLine) {
        const dom = document.getElementById('line-chart');
        dom.innerHTML = "";  // limpiar div
        chartLine = echarts.init(dom);

        const seriesLine = datosAcumulados.map(sub => ({
          name: sub.tipo,
          type: 'line',
          data: meses.map(m => sub.valores[m])
        }));

        chartLine.setOption({
          tooltip: { trigger: 'axis' },
          legend: { data: datosAcumulados.map(d => d.tipo), top: '90%', left: 'center' },
          xAxis: { type: 'category', data: meses },
          yAxis: { type: 'value' },
          grid: { top: 180, bottom: 150, left: 50, right: 50 },
          title: {
            text: 'Totales de Suscripciones por Mes',
            subtext: 'Nota: se consideran las suscripciones separadas por tipo',
            left: 'center',
            top: 0
          },
          series: seriesLine,
          animation: true,
          animationDuration: 1500,
          animationEasing: 'cubicOut'
        });
      } else {
        // Ya existe: solo redimensionar
        chartLine.resize();
      }
    }

    function initRoseChart() {
      if (!chartRose) {
        const dom = document.getElementById('rose-chart');
        dom.innerHTML = "";
        chartRose = echarts.init(dom);

        const totalesMes = meses.map(m =>
          datosAcumulados.reduce((acc, sub) => acc + (sub.valores[m] || 0), 0)
        );
        const dataRose = meses.map((m, i) => ({ value: totalesMes[i], name: m }));

        chartRose.setOption({
          grid: { top: 180, bottom: 80, left: 50, right: 50 },
          legend: { orient: 'horizontal', top: '90%', left: 'center' },
          title: {
            text: 'Totales de Suscripciones por Mes',
            subtext: 'Nota: se consideran todos los tipos de suscripciones acumulados',
            left: 'center',
            top: 0
          },
          tooltip: { trigger: 'item', formatter: "{b}: {c} suscripciones" },
          series: [{
            name: 'Totales por Mes',
            type: 'pie',
            radius: [50, 250],
            center: ['50%', '50%'],
            roseType: 'area',
            itemStyle: { borderRadius: 8 },
            label: { show: true, formatter: "{b}\n{c} suscripciones" },
            labelLine: { show: true, length: 20, length2: 10 },
            data: dataRose
          }],
          animation: true,
          animationDuration: 1500,
          animationEasing: 'cubicOut'
        });
      } else {
        // Ya existe: solo redimensionar
        chartRose.resize();
      }
    }

    function initBarChart() {
      if (!chartBar) {
        const dom = document.getElementById('bar-chart');
        dom.innerHTML = "";
        chartBar = echarts.init(dom);

        const seriesBar = datosBar.map(sub => ({
          name: sub.tipo,
          type: 'bar',
          data: meses.map(m => sub.valores[m])
        }));

        chartBar.setOption({
          tooltip: { trigger: 'axis' },
          legend: { data: datosBar.map(d => d.tipo), top: '90%', left: 'center' },
          xAxis: { type: 'category', data: meses },
          yAxis: { type: 'value' },
          grid: { top: 180, bottom: 150, left: 50, right: 50 },
          title: {
            text: 'Totales de Suscripciones por Mes',
            subtext: 'Nota: se consideran las suscripciones separadas por tipo',
            left: 'center',
            top: 0
          },
          series: seriesBar,
          animation: true,
          animationDuration: 1500,
          animationEasing: 'cubicOut'
        });
      } else {
        // Ya existe: solo redimensionar
        chartBar.resize();
      }
    }

    // --- Navegación entre tabs ---
    document.querySelectorAll(".nav-link").forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        document.querySelectorAll(".nav-link").forEach(l => l.classList.remove("active"));
        link.classList.add("active");

        const tab = link.getAttribute("data-tab");
        document.getElementById("rose-chart").style.display = (tab === "rose") ? "block" : "none";
        document.getElementById("line-chart").style.display = (tab === "line") ? "block" : "none";
        document.getElementById("bar-chart").style.display = (tab === "bar") ? "block" : "none";

        if (tab === "line") initLineChart();
        if (tab === "rose") initRoseChart();
        if (tab === "bar") initBarChart();
      });
    });

    // Ajustar tamaño al redimensionar ventana
    window.addEventListener("resize", () => {
      chartLine?.resize();
      chartRose?.resize();
      chartBar?.resize();
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
